---
layout: post
title: JPA (3)
category: JPA
---
## 엔티티 매핑

**@Entity**

- @Entity가 붙은 클래스는 JPA가 관리
- JPA를 사용해서 테이블과 매핑할 클래스는 @Entity 필수
- 기본 생성자 필수 (파라미터가 없는 public 또는 protected 생성자)
- final 클래스, enum, interface, inner 클래스 사용 금지
- 저장할 필드에 final 사용 금지

<br>
**데이터베이스 스키마 자동 생성**

- DDL(Data Definition Language <small>e.g. CREATE</small>)을 애플리케이션 실행 시점에 자동 생성
- 테이블 중심 → 객체 중심
- 데이터베이스 방언을 활용해서 데이터베이스에 맞는 적절한 DDL 생성
- 운영 장비에는 절대로 create, create-drop, update를 사용하면 안된다.
- 개발 초기단계는 create 또는 update
- 스테이징과 운영 서버는 validate 또는 none


<br>
<br>
## 필드와 컬럼 매핑

**@Column**

- name : 필드와 매핑할 테이블의 컬럼 이름
- length : 문자 길이 제약 조건

<br>
**@Enumerated**

- 자바 enum 타입을 매핑할 때 사용
- ORDINAL을 사용 금지

<br>
**@Lob**

- 데이터베이스 BLOB, CLOB 타입과 매핑
- 매핑하는 필드 타입이 문자면 CLOB 매핑, 나머지는 BLOB 매핑

<br>
**@Transient**

- 필드 매핑 X
- 데이터베이스에 저장 X, 조회 X
- 주로 메모리상에서만 임시로 어떤 값을 보관하고 싶을 때 사용


<br>
<br>
## 기본 키 매핑

**직접 할당 : @Id만 사용**

<br>
**자동 생성 (@GeneratedValue)**

- IDENTITY
	- 기본 키 생성을 데이터베이스에 위임
	- em.persist() 시점에 즉시 INSERT SQL 실행하고 데이터베이스에서 식별자를 조회

- SEQUENCE
	- 데이터베이스 시퀀스는 유일한 값을 순서대로 생성하는 특별한 데이터베이스 오브젝트 (예: 오라클 시퀀스)

- TABLE
	- 키 생성 전용 테이블을 하나 만들어서 데이터베이스 시퀀스를 흉내내는 전략
	- 장점 : 모든 데이터베이스에 적용 가능
	- 단점 : 성능

<br>
**권장하는 식별자 전략**
	
- 기본 키 제약 조건 : null 아님, 유일, 변하면 안된다.
- 미래까지 이 조건을 만족하는 자연키는 찾이 어려우므로 대체키를 사용하자.
- 권장 : Long형 + 대체키 + 키 생성전략 사용


<br>
<br>
## 연관관계 매핑

**객체와 테이블 연관관계의 차이**
	
- 테이블은 외래 키로 조인을 사용해서 연관된 테이블을 찾는다.
- 객체는 참조를 사용해서 연관된 객체를 찾는다.

<br>
**객체의 양방향 관계**
	
- 객체의 양방향 관계는 사실 양방향 관계가 아니라 서로 다른 단방향 관계 2개다.
- 객체를 양방향으로 참조하려면 단방향 연관관계를 2개 만들어야한다.

<br>
**테이블의 양방향 연관관계**

- 테이블은 외래 키 하나로 두 테이블의 연관관계를 관리
- 양쪽으로 조인 가능

<br>
**양방향 매핑 규칙**

- 객체의 두 관계중 하나를 연관관계의 주인으로 지정
- 연관관계의 주인만이 외래 키를 관리 (등록, 수정)
- 주인이 아닌쪽은 읽기만 가능
- 주인은 mappedBy 속성 사용 X
- 주인이 아니면 mappedBy 속성으로 주인 지정
- 주인은 외래키가 있는 곳으로 정하라

<br>
**양방향 연관관계 주의**

- 순수 객체 상태를 고려해서 항상 양쪽에 값을 설정하자
- 연관관계 편의 메소드를 생성하자

<br>
**양방향 매핑 정리**

- 단뱡향 매핑만으로도 이미 연관관계 매핑은 완료
- 양방향 매핑은 반대 방향으로 조회(객체 그래프 탐색) 기능이 추가된 것 뿐
- JPQL에서 역방향으로 탐색할 일이 많음
- 단뱡향 매핑을 잘 하고 양방향은 필요할 때 추가해도 됨 (테이블에 영향을 주지 않음)

<br>
**연관관계의 주인은 외래 키의 위치를 기준으로 정해야한다.**


<br>
<br>
## 다양한 연관관계 매핑

**연관관계 매핑시 고려사항 3가지**
	
- 다중성
- 단방향, 양방향
- 연관관계의 주인

<br>
**다중성**

- 다대일 : @ManyToOne
- 일대다 : @OneToMany
- 일대일 : @OneToOne
- 다대다 : @ManyToMany

<br>
**단뱡향, 양방향**

- 테이블
	- 외래 키 하나로 양쪽 조인 가능
	- 사실 방향이라는 개념이 없음
- 객체
	- 참조용 필드가 있는 쪽으로만 참조 가능
	- 한쪽만 참조하면 단방향
	- 양쪽이 서로 참조하면 양방향

<br>
**연관관계의 주인**

- 테이블은 외래 키 하나로 두 테이블이 연관관계를 맺음
- 객체 양방향 관계는 A→B, B→A 처럼 참조가 2군데
- 객체 양방향 관계는 참조가 2군데 있음. 둘 중 테이블의 외래 키를 관리할 곳을 지정해야함
- 연관관계의 주인 : 외래 키를 관리하는 참조
- 주인의 반대편 : 외래 키에 영향을 주지 않음, 단순 조회만 가능


<br>
<br>
<br>
----------------------------------------------------------------------------------------
<br>
참고: 김영한, [자바 ORM 표준 JPA 프로그래밍 - 기본편](https://www.inflearn.com/course/ORM-JPA-Basic/), Inflearn